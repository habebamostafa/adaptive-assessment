# QUESTIONS = {
#     # ------------------------------
#     # Web Development Track
#     # ------------------------------
#     "web": {
#         1: [  # Easy
#             {
#                 'text': "Which language is the core of web page structure?",
#                 'options': ["HTML", "Python", "Java", "C++"],
#                 'correct_answer': "HTML"
#             },
#             {
#                 'text': "What does CSS stand for?",
#                 'options': ["Computer Style Sheets", "Creative Style Sheets", 
#                           "Cascading Style Sheets", "Colorful Style Sheets"],
#                 'correct_answer': "Cascading Style Sheets"
#             },
#             {
#                 'text': "Which HTML tag is used for paragraphs?",
#                 'options': ["<p>", "<para>", "<paragraph>", "<pg>"],
#                 'correct_answer': "<p>"
#             },
#             {
#                 'text': "What does HTML stand for?",
#                 'options': ["Hyperlinks and Text Markup Language", "Home Tool Markup Language",
#                           "Hyper Text Markup Language", "Hyper Transfer Markup Language"],
#                 'correct_answer': "Hyper Text Markup Language"
#             },
#             {
#                 'text': "Which tag creates a hyperlink?",
#                 'options': ["<link>", "<a>", "<href>", "<url>"],
#                 'correct_answer': "<a>"
#             },
#             {
#                 'text': "What is the correct way to comment in HTML?",
#                 'options': ["<!-- comment -->", "// comment", "/* comment */", "# comment"],
#                 'correct_answer': "<!-- comment -->"
#             }
#         ],
#         2: [  # Medium
#             {
#                 'text': "Which React hook is used for side effects?",
#                 'options': ["useState", "useEffect", "useContext", "useReducer"],
#                 'correct_answer': "useEffect"
#             },
#             {
#                 'text': "What does API stand for?",
#                 'options': ["Application Programming Interface", "Automated Programming Interface",
#                           "Advanced Programming Instruction", "Application Process Integration"],
#                 'correct_answer': "Application Programming Interface"
#             },
#             {
#                 'text': "What is the purpose of JavaScript in web development?",
#                 'options': ["Structure content", "Style pages", "Add interactivity", "Create databases"],
#                 'correct_answer': "Add interactivity"
#             },
#             {
#                 'text': "Which method adds a new element to an array?",
#                 'options': ["array.add()", "array.push()", "array.insert()", "array.append()"],
#                 'correct_answer': "array.push()"
#             },
#             {
#                 'text': "What is the box model in CSS?",
#                 'options': ["A way to package CSS files", "A layout concept with margin, border, padding",
#                             "A 3D modeling technique", "A JavaScript framework"],
#                 'correct_answer': "A layout concept with margin, border, padding"
#             }
#         ],
#         3: [  # Hard
#             {
#                 'text': "Which HTTP status code indicates 'Not Found'?",
#                 'options': ["200", "301", "404", "500"],
#                 'correct_answer': "404"
#             },
#             {
#                 'text': "What is the virtual DOM in React?",
#                 'options': ["A lightweight version of the real DOM", "A 3D visualization tool",
#                           "A security feature", "A testing framework"],
#                 'correct_answer': "A lightweight version of the real DOM"
#             },
#             {
#                 'text': "What is CORS in web development?",
#                 'options': ["A security feature", "A programming language",
#                           "A database system", "A testing framework"],
#                 'correct_answer': "A security feature"
#             },
#             {
#                 'text': "What is the purpose of Webpack?",
#                 'options': ["To bundle JavaScript files", "To create databases",
#                           "To style web pages", "To replace HTML"],
#                 'correct_answer': "To bundle JavaScript files"
#             },
#             {
#                 'text': "What does SSR stand for in Next.js?",
#                 'options': ["Server-Side Rendering", "Static Site Rendering",
#                           "Secure Socket Rendering", "System Style Rules"],
#                 'correct_answer': "Server-Side Rendering"
#             }
#         ]
#     },

#     # ------------------------------
#     # Artificial Intelligence Track
#     # ------------------------------
#     "ai": {
#         1: [
#             {
#                 'text': "What is the most common programming language for AI?",
#                 'options': ["Python", "C#", "Ruby", "Go"],
#                 'correct_answer': "Python"
#             },
#             {
#                 'text': "What does AI stand for?",
#                 'options': ["Automated Intelligence", "Artificial Intelligence",
#                           "Advanced Interface", "Algorithmic Inference"],
#                 'correct_answer': "Artificial Intelligence"
#             },
#             {
#                 'text': "Which library is commonly used for machine learning in Python?",
#                 'options': ["TensorFlow", "Django", "Flask", "Pandas"],
#                 'correct_answer': "TensorFlow"
#             }
#         ],
#         2: [
#             {
#                 'text': "Which algorithm is used for classification tasks?",
#                 'options': ["Linear Regression", "K-Means", "Decision Tree", "Apriori"],
#                 'correct_answer': "Decision Tree"
#             },
#             {
#                 'text': "What is supervised learning?",
#                 'options': ["Learning with labeled data", "Learning without guidance",
#                           "Learning from rewards", "Learning from unstructured data"],
#                 'correct_answer': "Learning with labeled data"
#             },
#             {
#                 'text': "What is the purpose of a neural network?",
#                 'options': ["To mimic human brain function", "To style web pages",
#                           "To create databases", "To replace HTML"],
#                 'correct_answer': "To mimic human brain function"
#             }
#         ],
#         3: [
#             {
#                 'text': "What does CNN stand for in deep learning?",
#                 'options': ["Common Neural Network", "Convolutional Neural Network",
#                           "Complex Neural Node", "Centralized Neural Network"],
#                 'correct_answer': "Convolutional Neural Network"
#             },
#             {
#                 'text': "What is the purpose of backpropagation?",
#                 'options': ["To adjust neural network weights", "To collect data",
#                           "To visualize results", "To preprocess input"],
#                 'correct_answer': "To adjust neural network weights"
#             },
#             {
#                 'text': "What is transfer learning?",
#                 'options': ["Reusing a pre-trained model", "Moving data between servers",
#                           "Changing programming languages", "Converting code to binary"],
#                 'correct_answer': "Reusing a pre-trained model"
#             }
#         ]
#     },

#     # ------------------------------
#     # Cyber Security Track
#     # ------------------------------
#     "cyber": {
#         1: [
#             {
#                 'text': "What is the most common type of cyber attack?",
#                 'options': ["Phishing", "DDoS", "MITM", "Zero-day"],
#                 'correct_answer': "Phishing"
#             },
#             {
#                 'text': "What is a firewall used for?",
#                 'options': ["Network security", "Data storage",
#                           "Website design", "Programming"],
#                 'correct_answer': "Network security"
#             },
#             {
#                 'text': "What does HTTPS stand for?",
#                 'options': ["HyperText Transfer Protocol Secure", "Hyper Transfer Text Protocol",
#                           "High-Tech Transfer Protocol", "HyperText Transfer Protocol Standard"],
#                 'correct_answer': "HyperText Transfer Protocol Secure"
#             }
#         ],
#         2: [
#             {
#                 'text': "What does VPN stand for?",
#                 'options': ["Virtual Private Network", "Verified Personal Node",
#                           "Virtual Public Network", "Verified Protocol Network"],
#                 'correct_answer': "Virtual Private Network"
#             },
#             {
#                 'text': "What is two-factor authentication?",
#                 'options': ["An extra security layer", "A type of virus",
#                           "A network protocol", "A programming language"],
#                 'correct_answer': "An extra security layer"
#             },
#             {
#                 'text': "What is encryption?",
#                 'options': ["Scrambling data for security", "Deleting files",
#                           "Creating backups", "Formatting disks"],
#                 'correct_answer': "Scrambling data for security"
#             }
#         ],
#         3: [
#             {
#                 'text': "Which encryption algorithm is asymmetric?",
#                 'options': ["AES", "RSA", "DES", "3DES"],
#                 'correct_answer': "RSA"
#             },
#             {
#                 'text': "What is a zero-day vulnerability?",
#                 'options': ["An unknown security flaw", "A type of firewall",
#                           "An encryption method", "A network protocol"],
#                 'correct_answer': "An unknown security flaw"
#             },
#             {
#                 'text': "What is penetration testing?",
#                 'options': ["Authorized hacking attempt", "Data encryption",
#                           "Virus scanning", "Network monitoring"],
#                 'correct_answer': "Authorized hacking attempt"
#             }
#         ]
#     },

#     # ------------------------------
#     # Data Science Track
#     # ------------------------------
#     "data": {
#         1: [
#             {
#                 'text': "What is the primary tool for data analysis in Python?",
#                 'options': ["Pandas", "Django", "TensorFlow", "Flask"],
#                 'correct_answer': "Pandas"
#             },
#             {
#                 'text': "What is a DataFrame?",
#                 'options': ["2D data structure", "A chart type",
#                           "A database", "A file format"],
#                 'correct_answer': "2D data structure"
#             },
#             {
#                 'text': "What does CSV stand for?",
#                 'options': ["Comma Separated Values", "Computer System Variables",
#                           "Columnar Storage Version", "Coded Secure Variables"],
#                 'correct_answer': "Comma Separated Values"
#             }
#         ],
#         2: [
#             {
#                 'text': "Which type of variable is 'age'?",
#                 'options': ["Categorical", "Numerical", "Ordinal", "Binary"],
#                 'correct_answer': "Numerical"
#             },
#             {
#                 'text': "What is data cleaning?",
#                 'options': ["Fixing errors in datasets", "Deleting old data",
#                           "Encrypting data", "Visualizing data"],
#                 'correct_answer': "Fixing errors in datasets"
#             },
#             {
#                 'text': "What is the purpose of Matplotlib?",
#                 'options': ["Data visualization", "Web development",
#                           "Machine learning", "Database management"],
#                 'correct_answer': "Data visualization"
#             }
#         ],
#         3: [
#             {
#                 'text': "What does EDA stand for in data science?",
#                 'options': ["Electronic Data Analysis", "Exploratory Data Analysis",
#                           "Estimated Data Assessment", "Extended Data Algorithm"],
#                 'correct_answer': "Exploratory Data Analysis"
#             },
#             {
#                 'text': "What is feature engineering?",
#                 'options': ["Creating better input features", "Building UI features",
#                           "Designing databases", "Writing documentation"],
#                 'correct_answer': "Creating better input features"
#             },
#             {
#                 'text': "What is overfitting in machine learning?",
#                 'options': ["Model memorizing training data", "Too much data",
#                           "Slow training", "Incomplete data"],
#                 'correct_answer': "Model memorizing training data"
#             }
#         ]
#     },

#     # ------------------------------
#     # Mobile Development Track
#     # ------------------------------
#     "mobile": {
#         1: [
#             {
#                 'text': "Which language is used for native Android development?",
#                 'options': ["Swift", "Kotlin", "C#", "JavaScript"],
#                 'correct_answer': "Kotlin"
#             },
#             {
#                 'text': "What is Flutter used for?",
#                 'options': ["Cross-platform mobile apps", "Web development",
#                           "Game development", "Data analysis"],
#                 'correct_answer': "Cross-platform mobile apps"
#             },
#             {
#                 'text': "Which language is used for iOS development?",
#                 'options': ["Java", "Kotlin", "Swift", "Dart"],
#                 'correct_answer': "Swift"
#             }
#         ],
#         2: [
#             {
#                 'text': "What is React Native used for?",
#                 'options': ["Web development", "Mobile app development",
#                           "Game development", "Data analysis"],
#                 'correct_answer': "Mobile app development"
#             },
#             {
#                 'text': "What is an APK file?",
#                 'options': ["Android application package", "Apple program kit",
#                           "Application programming key", "Automated process kernel"],
#                 'correct_answer': "Android application package"
#             },
#             {
#                 'text': "What is Jetpack Compose?",
#                 'options': ["Modern UI toolkit for Android", "iOS development framework",
#                           "Cross-platform solution", "Backend technology"],
#                 'correct_answer': "Modern UI toolkit for Android"
#             }
#         ],
#         3: [
#             {
#                 'text': "Which architecture pattern is commonly used in mobile apps?",
#                 'options': ["MVC", "SOLID", "OOP", "HTTP"],
#                 'correct_answer': "MVC"
#             },
#             {
#                 'text': "What is Firebase commonly used for in mobile apps?",
#                 'options': ["Backend services", "UI design",
#                           "Game engines", "Data analysis"],
#                 'correct_answer': "Backend services"
#             },
#             {
#                 'text': "What is the purpose of Gradle in Android development?",
#                 'options': ["Build automation", "UI design",
#                           "Database management", "Networking"],
#                 'correct_answer': "Build automation"
#             }
#         ]
#     }
# }

import json
from langchain.chains import LLMChain
from langchain.prompts import PromptTemplate
from langchain_community.llms import HuggingFaceHub
import os
from dotenv import load_dotenv
import streamlit as st
# Load environment variables
load_dotenv()
huggingfacehub_token = st.secrets["huggingfacehub_token"]

def initialize_model():
    """Initialize and return the HuggingFace model"""
    return HuggingFaceHub(
        repo_id="google/flan-t5-large",
        task="text2text-generation",
        huggingfacehub_api_token=huggingfacehub_token,
        model_kwargs={
            "temperature": 0.7,
            "max_length": 200
        }
    )

def validate_question_format(question_dict):
    """Validate the question structure"""
    required_keys = {"text", "options", "correct_answer", "track", "level"}
    return all(key in question_dict for key in required_keys)

def generate_question(track, level):
    """Generate adaptive question with validation"""
    # Initialize components
    llm = initialize_model()
    
    template = """
    You are an expert teacher in the field of {track}. 
    Create a {level} question with 4 options and only one correct answer.

    Difficulty levels:
    - 1: Easy (basic knowledge)
    - 2: Medium (practical applications)
    - 3: Hard (advanced analysis)

    Return the output in the following JSON format:
    {{
        "text": "Question text",
        "options": ["Option1", "Option2", "Option3", "Option4"],
        "correct_answer": "Correct option",
        "track": "{track}",
        "level": {level}
    }}

    Question:
    """
    
    prompt = PromptTemplate.from_template(template)
    question_chain = LLMChain(llm=llm, prompt=prompt)
    
    try:
        response = question_chain.run(track=track, level=level)
        
        # Safer JSON parsing
        try:
            question_data = json.loads(response)
            if validate_question_format(question_data):
                return question_data
        except json.JSONDecodeError:
            pass
            
    except Exception as e:
        print(f"Error generating question: {str(e)}")
    
    # Fallback question
    return {
            "text": question_data["text"],
            "options": [str(opt) for opt in question_data["options"]],
            "correct_answer": str(question_data["correct_answer"]),
            "track": track,
            "level": level
    }


